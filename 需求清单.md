# 需求文档

## 1. 需求概览

### 主要改动点
1. 后端：定校推荐逻辑；
2. 前端：留学方案列表页
3. 前端：小希留学顾问页面

### 涉及端口
`B端` `PC` `移动`

### 改动目标
1. 通过coze智能体代替原有系统线性推荐逻辑，能够应对更加灵活的需求；
2. 能够智能理解学校过于自定义的录取要求，无需抽象成系统规则再开发；
3. 大模型能够通过系统库或联网查询提供一些关于申请的参考建议，提供更加有温度的服务；

## 2. 需求清单

| 模块 | 功能点 | 交互逻辑 | 数据来源 | 核心要求 |
| ---- | ------ | -------- | -------- | -------- |
| **后端** | 推荐逻辑调整 | 不再调用原推荐逻辑，开发新接口 | 用户输入参数 | 1. 原推荐逻辑不再调用<br>2. 开发新接口处理POST外网请求<br>3. 接收背景国家、申请国家等参数<br>4. 按分数上下限查询专业<br>5. 保留院校等级、list名单等逻辑<br>6. 背景国家非中英澳美按中国处理<br>7. 评估接口安全鉴权问题 |
| **后端** | 提交人工逻辑调整 | 走智能体推荐，人工方案补充 | 用户反馈 | 1. 原有AI推荐改为智能体推荐<br>2. 将用户反馈整合到prompt发送给智能体<br>3. 人工推回方案先提交到智能体B补充<br>4. 智能体B确保格式与智能体A一致<br>5. 获取B返回数据后再返回前端渲染 |
| **留学方案列表** | 功能按钮优化 | 优化页面头部功能按钮 | - | 1. 保留"下载方案模板"按钮<br>2. 保留"查看更多方案"按钮<br>3. 保留"提交人工优化"按钮<br>4. 新增"重新推荐方案"按钮<br>5. 新增"功能引导"按钮 |
| **留学方案列表** | 方案卡片展示优化 | 优化方案卡片内容的展示布局 | 智能体方案数据 | 1. 优化卡片内容的展示布局<br>2. 保持现有功能<br>3. 增加信息展开/收起按钮<br>4. 根据原型实现信息与排版 |
| **留学方案列表** | 方案操作功能新增 | 布局调整，突出锁定与同步按钮 | - | 1. 保留同步到定校功能<br>2. 新增方案锁定功能<br>3. 将其他功能收起到更多菜单<br>4. 保留编辑方案、复制方案等功能<br>5. 编辑点击后弹窗显示表单 |
| **留学方案列表** | 方案锁定功能 | 实现方案锁定功能，防止方案刷新 | - | 1. 卡片右上角添加锁定/解锁按钮<br>2. 锁定状态下禁止编辑、删除、重推<br>3. 锁定状态存储到数据库确保持久化<br>4. 锁定不影响人工优化功能<br>5. 记录锁定功能操作数据跟踪使用 |
| **留学方案列表** | 重新推荐方案 | 通过智能体生成新的方案 | 智能体推荐数据 | 1. 点击按钮弹出抽屉显示表单<br>2. 已锁定方案不参与重新推荐<br>3. 锁定方案不占用推荐数量配额<br>4. 显示三步式加载动画<br>5. 记录按钮点击数据分析 |
| **留学方案列表** | 编辑对话框优化 | 收起到更多功能菜单 | 方案数据和用户编辑内容 | 1. 保留现有对话框布局和字段结构<br>2. 确保可编辑字段正确显示支持修改<br>3. 保留只读字段的样式和标识<br>4. 保持现有必填字段规则和校验逻辑<br>5. 新增可编辑字段：语言要求(IELTS、TOEFL)、学术要求(GPA、背景要求)、其他信息(院系、校区、申请建议) |
| **留学方案列表** | 方案评价功能（已删除，暂不实现） | 方案推荐后用户首次浏览到页面底部触发评价弹窗 | - | 1. 记录评级弹出日志数据与评价结果关联<br>2. 使用5星评级系统，4星以下显示标签选项<br>3. 每个用户30日内最多弹出1次 |
| **小希留学顾问** | 方案任务逻辑调整 | 任务分发逻辑调整 | 对话内容 | 1. 识别方案任务调用coze智能体<br>2. 智能体设置追问逻辑<br>3. 对每句话识别方案制作/追问/其他意图<br>4. 其他意图则结束智能体任务重新分发<br>5. 根据意图类型决定渲染方式 |
| **小希留学顾问** | 消息卡片渲染 | 根据意图确定渲染方式 | 智能体消息 | 1. 根据UI实现三步动画渲染展示<br>2. 根据方案数据完成卡片渲染<br>3. 保留复制、重新发送、点赞点踩功能 |
| **小希留学顾问** | 转到资源方案 | 方案卡片跳转到资源方案标签页 | 智能体生成的方案数据 | 1. 智能体同时返回格式化用户信息<br>2. 点击按钮跳转并触发新增弹窗<br>3. 自动填入智能体返回的资源信息 |
| **其他** | 提交平台优化 | 处理反馈信息 | 用户提交的反馈信息 | 1. 拼接其他要求和人工反馈信息<br>2. 使用分号分隔拼接信息<br>3. 确保格式统一易读 |
| **其他** | 成绩类型默认值优化 | 根据背景学历自动设置默认值 | 用户背景学历信息 | 1. 硕士背景时自动设置为"其他成绩类型" |
| **其他** | 下载模板优化 | 优化展示和下载功能 | 模板数据和用户信息 | 1. 按UI调整模板样式突出补充信息<br>2. 空字段自动隐藏<br>3. 预览直接使用页面展示<br>4. 下载使用页面打印功能生成PDF |

### 2.1 后端推荐逻辑调整：
1. 原推荐逻辑不再调用；
2. 出具一个接口，接口需求说明：
```
请求方式：
post外网请求
入参：
背景国家、申请国家(可多选)、申请学历（本科、硕士）、分制、分数上限、分数下限、中国院校名称；
返回数据：
查询到的专业数量、专业列表（专业id、院校英文名、专业英文名）
查询逻辑：
1. 查询院校等级、根据院校等级匹配对应均分（985、211等）等逻辑保留；
2. 院校要求中有list名单，需查询是否在list范围内，逻辑保留；
3. 背景国家非中、英、澳、美均按照中国背景处理；
4. 硕士分制转换百分制，逻辑去除（调用接口前大模型已完成转换）；
5. 按分数上下限查询录取要求在该范围内的专业（闭区间查询）；
```
**接口用于火山引擎coze平台调用，需评估安全问题，评估是否需要配置鉴权；** 

3. 平台调用Coze智能体会话接口，详见[Coze接口文档](https://www.coze.cn/open/docs/developer_guides/chat_v3#337f3d53)
```
会话要求
1. 附带上下文进行会话；
2. 接口会返回收集到的学生信息，需要暂存起来，用于后续快速转到资源创建、学生创建等操作；
```

### 2.2 提交人工逻辑调整
1. 原有提人工前走AI推荐逻辑保留，改为走智能体推荐，将填写的反馈整合到prompt一同发送给智能体；
2. 成功提交人工后，人工推回的方案先提交到智能体B（另一个智能体，负责对人工方案进行信息补充），智能体B将对人工方案补充建议等信息，保障与智能体A返回的数据格式、要求等一致，系统接受到智能体B的返回数据后再返回前端一同渲染；

### 2.3 留学方案列表页面

#### 功能点 1：方案列表页面功能按钮优化
- **交互逻辑**：优化页面头部功能按钮和交互行为
- **数据来源**：-
- **具体要求**：
  1. 保留现有的"下载方案模板"功能按钮，用于导出方案模板
  2. 保留"查看更多方案"功能按钮，用于展示额外的方案选项
  3. 保留"提交人工优化"功能按钮，用于将方案提交给顾问人工优化
  4. 新增"重新推荐方案"功能按钮，整合新的智能体调用逻辑
  5. 新增"功能引导"按钮，优化引导流程和视觉提示

#### 功能点 2：方案卡片展示优化
- **交互逻辑**：优化方案卡片内容的展示布局，保持现有功能，新增信息展开/收起按钮
- **数据来源**：智能体方案数据
- **具体要求**：
  1. 优化卡片内容的展示布局
  2. 保持现有功能
  3. 增加信息展开/收起按钮
  4. 根据原型实现信息与排版

#### 功能点 3：方案操作功能新增
- **交互逻辑**：布局调整，突出方案锁定与方案同步按钮，原有其他功能收起到更多功能菜单，新增方案锁定功能
- **数据来源**：-
- **具体要求**：
  1. 保留同步到定校功能
  2. 新增方案锁定功能，确保重新推荐时不会刷新锁定的方案、人工推荐不受该影响
  3. 保留更多菜单中的编辑方案、复制方案、查看申请材料、删除方案等功能
  4. 编辑点击后，弹窗，窗体主要内容为表单，详见原型，用户在表单中进行方案编辑与保存；

#### 功能点 4：方案锁定功能
- **交互逻辑**：实现方案锁定功能，防止方案刷新
- **数据来源**：-
- **具体要求**：
  1. 在方案卡片右上角添加锁定/解锁按钮，使用锁形图标直观展示状态，详见UI
  2. 锁定状态下，方案不能被编辑、删除或重新推荐，但不影响人工推荐
  3. 锁定状态在数据库存储，确保刷新页面后状态不丢失
  4. 锁定状态不影响人工优化功能，人工可以对锁定的方案修改和删除，若人工优化完，方案专业id未变，则视为同一个专业方案，锁定状态保持不变
  5. 记录锁定功能操作数据，用于新功能上线后的数据跟踪，验证功能使用情况

#### 功能点 5：重新推荐方案
- **交互逻辑**：实现方案重新推荐功能，通过智能体生成新的方案
- **数据来源**：智能体推荐数据
- **具体要求**：
  1. 点击"重新推荐方案"按钮后，弹出抽屉，显示需填写的表单信息，内容详见UI
  2. 已锁定的方案不参与重新推荐，保持原有方案不变
  3. 已锁定的方案不占用推荐方案数量，若锁定2所，重新推回5所，则列表变为7所
  4. 点击重新推荐时，方案面板出现三步式加载动画，详见UI设计
  5. 记录按钮点击数据，记录提交按钮与取消按钮点击数据，用于上线后的数据分析

#### 功能点 6：编辑对话框功能优化
- **交互逻辑**：将编辑功能收起到更多功能菜单，点击后弹窗进行方案表单编辑，具体字段详见原型；
- **数据来源**：方案数据和用户编辑内容
- **具体要求**：
  1. 保留现有编辑对话框的布局和字段结构
  2. 确保所有可编辑字段正确显示并支持用户修改
  3. 保留只读字段的样式和标识
  4. 现有的必填字段规则以及字段内容校验不变
  5. 当前版本可编辑字段缺失如下字段，需新增：语言要求：IELTS、TOEFL;学术要求：GPA、背景要求；其他信息：院系、校区、申请建议；

#### 功能点 7：方案评价功能（已删除，暂不实现）
- **交互逻辑**：当方案推荐后（首次推荐或主动点击重新推荐按钮），用户首次浏览页面到最底部，则触发评价弹窗，右下角弹窗；
- **数据来源**：-
- **具体要求**：
  1. 记录评级弹出日志数据，与用户的评价结果进行关联（后续根据提交率数据调整评价弹出方式）；
  2. 以5颗星级的方式让用户选择评价星级，若选择4星或以下，则星级下方会出现："院校信息不准"、"推荐院校不准"、"流程复杂"三个标签供用户选择，用户可选可不选，同时支持填写文本反馈，详见UI；
  3. 每个用户30日内最多弹出1次；

### 2.4 小希留学顾问页面

#### 功能点 1：方案任务逻辑调整
- **交互逻辑**：任务分发逻辑调整
- **数据来源**：对话内容
- **具体要求**：
  1. 当识别到方案任务时，调用coze智能体接口发起对话；
  2. coze智能体中设置有追问逻辑，若识别到信息不足，则返回追问问题，保持方案任务状态；
  3. coze将对收到的每一句对话结合上下文识别意图，会返回三类意图：1. 方案制作；2. 信息追问；3. 其他意图；
  4. 若识别到其他意图，则智能体当前任务结束，小希使用用户问题重新识别意图并分发；
  5. 若用户意图是方案制作，则根据原型给定的样式进行智能体小希渲染，否则按照文本消息渲染即可；

#### 功能点 2：消息卡片渲染
- **交互逻辑**：智能体会优先返回意图，根据意图类型确定是否使用方案卡片的渲染
- **数据来源**：智能体消息
- **具体要求**：
  1. 根据UI进行三步动画的渲染、展示；
  2. 智能体返回方案数据后，根据UI完成卡片的渲染；
  3. 原有的复制、重新发送、点踩、点赞功能保留不变；

#### 功能点 3：转到资源方案
- **交互逻辑**：方案卡片有转到资源的按钮，点击后跳转到资源方案标签页
- **数据来源**：智能体生成的方案数据
- **具体要求**：
  1. 生成方案的同时，智能体会返回解析出的格式化的用户信息
  2. 点击按钮后，跳转到资源方案页面，触发新增资源弹窗
  3. 系统自动将智能体返回的资源信息填入表单，等待用户操作

### 其他需求
#### 功能点 1：提交平台优化
- **交互逻辑**：优化提交平台反馈信息的处理逻辑
- **数据来源**：用户提交的反馈信息
- **具体要求**：
  1. 当用户填写其他要求后又提交人工反馈时，将两者信息进行拼接
  2. 管理后台和开放平台均采用分号分隔的方式拼接信息（其他要求 ； 提交人工反馈）
  3. 确保信息拼接后的格式统一且易于阅读

#### 功能点 2：成绩类型默认值优化
- **交互逻辑**：根据用户背景学历自动设置成绩类型默认值
- **数据来源**：用户背景学历信息
- **具体要求**：
  1. 当用户背景学历为硕士时，自动将成绩类型设置为"其他成绩类型"

#### 功能点 3：下载模板优化
- **交互逻辑**：优化下载模板的展示和下载功能
- **数据来源**：模板数据和用户信息
- **具体要求**：
  1. 按照UI设计调整模板样式，突出展示补充信息
  2. 当字段内容为空时自动隐藏该字段
  3. 预览功能改为直接使用页面展示，不再生成PDF
  4. 下载时直接调用页面打印功能生成PDF文件

  ## B端小程序：小希云服务
  同步调整小希助理对话页以及方案列表页，详见UI

  ## 补充的注意点：
  1. 小希助理对话时：点击同步至资源方案按钮，不创建学生，直接显示弹窗，将AI带的信息填充过去，让用户填写姓名自己创建；
  2. 多轮对话如果有多个学生，信息会错乱，风险点，暂时先不考虑，是小希助理整体对话流的问题，后续切换百炼时再解决；
  3. 补一个前端展示对应的后端字段图示；
  4. 小希对话流程；
  5. 返回任务状态，是否结束；
  6. 没返回专业ID，用户端交互；
  8. 加载中不可以操作提人工和重新推荐；
  9. 当前是否前端限制保持一个会话，同时只能进行一个会话；
  10. 个人分析字段长度限制，避免过长；
  11. B2C方案展示做缺省；


  ## 测试
  > 需注意压测环节，测试Coze回复的稳定性以及并发数
  
  ## 补充信息
  ```graph TD
    A[用户输入] --> B{主意图识别};
    B -- 留学方案制作意图 --> C[留学方案制作智能体];
    B -- 其他意图 --> D[其他任务处理逻辑];
    D --> E[返回答复并结束];

    C --> C1{方案制作智能体内部判断};
    C1 -- 非方案制作意图 --> F[主意图识别 (排除留学方案意图)];
    F --> B;
    C1 -- 信息缺失，需补充 --> G[提示用户补充信息];
    G --> H[用户再次输入];
    H -.-> C; subgraph 跳过主意图识别
    end
    C1 -- 信息完整，生成方案 --> I[返回完整留学方案并结束];
```
