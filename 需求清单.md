# 需求文档

## 1. 需求概览

### 主要改动点
1. 后端：定校推荐逻辑；
2. 前端：留学方案列表页
3. 前端：小希留学顾问页面

### 改动目标
1. 通过coze智能体代替原有系统线性推荐逻辑，能够应对更加灵活的需求；
2. 能够智能理解学校过于自定义的录取要求，无需抽象成系统规则再开发；
3. 大模型能够通过系统库或联网查询提供一些关于申请的参考建议，提供更加有温度的服务；

### 页面预览
[小希助理页](https://dwdestiny.github.io/agent2Plan/xiaoxi_assistant)

## 2. 需求清单
### 2.1 后端推荐逻辑调整：
1. 原推荐逻辑不再调用，改用Coze智能体接口；
2. 出具一个接口，接口需求说明：
```
请求方式：
post外网请求
入参：
背景国家、申请国家(可多选)、申请学历（本科、硕士）、分制、分数上限、分数下限、中国院校名称；
返回数据：
查询到的专业数量、专业列表（专业id、院校英文名、专业英文名）
查询逻辑：
1. 查询院校等级、根据院校等级匹配对应均分（985、211等）等逻辑保留；
2. 院校要求中有list名单，需查询是否在list范围内，逻辑保留；
3. 背景国家非中、英、澳、美均按照中国背景处理；
4. 硕士分制转换百分制，逻辑去除（调用接口前大模型已完成转换）；
5. 按分数上下限查询录取要求在该范围内的专业（闭区间查询）；
```

**接口用于火山引擎coze平台调用，需评估安全问题，评估是否需要配置鉴权；** 

3. 平台调用Coze智能体会话接口，详见[Coze接口文档](https://www.coze.cn/open/docs/developer_guides/chat_v3#337f3d53)

```
会话要求
1. 附带上下文进行会话；
2. 接口会返回收集到的学生信息，需要暂存起来，用于后续快速转到资源创建、学生创建等操作；
```
#### Coze返回数据示例


``` json5
{
  // 枚举 (String); 内容类型，例如："STUDENT_INFO" (仅有学生信息，走备选逻辑，调系统接口出方案), "PLAIN_TEXT_RESPONSE" (普通文本答复，前端普通消息气泡渲染), "FULL_PROGRAM_INFO" (完整方案信息，前端渲染方案卡片)
  type: "FULL_PROGRAM_INFO",
  // 枚举 (String); 任务状态，例如："IN_PROGRESS" (进行中), "COMPLETED" (已结束)
  taskStatus: "COMPLETED",
  // String; 普通文本类型的消息内容
  message: "请告知我您的GPA成绩，便于为您推荐更加精准的院校方案。",
  // Object; 个人评估信息
  personalAssessment: {
    // String; 针对学生的优势分析文本
    strengthAnalysis: "学生在校成绩优异，具备扎实的专业基础。",
    // String; 针对学生的提升点建议文本
    improvementPoints: "建议提升语言成绩，并增加相关科研或实习经历。",
    // String; 推荐方案的依据说明文本
    recommendationBasis: "基于学生的学术背景、个人兴趣及职业规划，综合评估得出以下推荐。",
  },
  // Object; 学生详细信息
  studentInfo: {
    // String; 背景国家，例如：中国
    backgroundCountry: "中国",
    // String; 毕业院校名称，例如：北京大学
    graduateInstitution: "北京大学",
    // Enum (String); 当前学历，枚举值：高中、专科、本科、硕士、博士、其他
    currentDegree: "本科",
    // Enum (String); 院校类型，枚举值：C9、985、211、非211（国外院校按照层次对应过来）
    institutionType: "C9",
    // Number (Float or String); GPA成绩，例如：3.8
    gpa: 3.8,
    // Number (Integer or Float); GPA满分值，仅支持数字，例如：4
    gpaTotal: 4,
    // Enum (String); GPA分制，枚举值：百分制、4分制、4.33分制、4.5分制、10分制、12分制、20分制、其他
    gpaScoreSystem: "4分制",
    // String; 所学专业名称，例如：计算机科学与技术
    major: "计算机科学与技术",
    // String; 语言成绩，例如：雅思7.0 或 托福100。若用户未提供，假设为雅思6.5分，并注明
    languageScore: "雅思7.0", // 或 "用户未给定成绩，假设雅思6.5分"
    // String; 工作经验描述
    workExperience: "曾在ABC科技公司担任软件工程师实习生6个月，参与XX项目开发。",
    // String; 其他优势描述
    otherAdvantages: "发表过两篇国际会议论文，获得国家级编程竞赛一等奖。",
    // String; 目标国家，例如：美国
    targetCountry: "美国",
    // String; 目标院校，可以是具体院校名称或意向范围
    targetInstitution: "斯坦福大学", // 或 "美国Top 30计算机院校"
    // String; 目标专业方向，例如：人工智能
    targetDirection: "人工智能",
    // String; 申请方向相关关键词，多个关键词用逗号分隔
    relatedKeywords: "机器学习,深度学习,自然语言处理",
    // Enum (String); 目标学历，枚举值：硕士、本科、其他
    targetDegree: "硕士",
    // String; 其他需求描述
    otherRequirements: "希望学校地理位置在加州，学制不超过两年，有Co-op项目机会。",
    // Array of Strings; 分类标签名称列表
    categoryName: [
      "计算机科学",
      "人工智能"
    ],
    // Array of Strings; 分类标签ID列表
    categoryId: [
      "001",
      "002"
    ]
  },
  // Array of Objects; 完整方案信息列表
  fullProgramInfoList: [
    {
      // String; 学术要求
      scienceRequirement: "相关专业学士学位，GPA达到3.0/4.0",
      // String; 专业英文名
      englishName: "Master of Computer Science",
      // Number (Boolean as 0 or 1); 是否为AI推荐，1表示是，0表示否
      isAi: 1,
      // String; 校区名称
      campusName: "St Lucia Campus",
      // String (URL); 专业链接
      majorLink: "https://study.uq.edu.au/study-options/programs/master-computer-science-5522",
      // String; 所在国家ID
      countryId: "12",
      // String; 院校ID
      schId: "55",
      // String; 院校介绍文本
      schoolIntroduction: "昆士兰大学是世界一流的教学和研究机构之一。",
      // String; 院校英文名
      schoolEnglishName: "The University of Queensland",
      // String or Number; QS世界大学排名
      qsRank: "47",
      // String; 专业背景要求
      professionalRequirement: "本科计算机科学、软件工程或相关信息技术专业背景",
      // String; 院校中文名
      schoolChineseName: "昆士兰大学",
      // String or Number; 雅思总分要求
      scoreIeltsTotal: "6.5",
      // String; 学制
      lengthOfFull: "1年, 1.5年",
      // String (URL); 院校LOGO图片链接
      schoolLogoUrl: "https://xiaoxi-cdn.globeedu.com/2019/01/04/png/2019010417572926803013.png",
      // String or Number; 托福总分要求
      scoreToeflTotal: "87",
      // String; 专业中文名
      chineseName: "计算机科学硕士",
      // String; 开学日期，多个日期用逗号分隔
      semester: "2024年2月19日, 2024年7月22日",
      // String; 专业ID
      projectId: "175384",
      // String; 学费
      feeTuition: "每年51200 AUD",
      // 枚举 (String); 方案标签，例如：稳妥, 冲刺, 备选
      type: "SAFE",
      // String; 标签，多个标签以斜杠分隔
      label: "费用低/学制短/排名高/就业广/工作签证",
      // String; 专业简要介绍
      introduction: "该课程提供计算机科学高级知识和技能，涵盖人工智能、数据科学等方向。",
      // Number; 专业方案推荐系数（1-10，10分对应5颗星）
      recommendRate: 9,
      // String; 针对该院校专业的申请建议
      applicationSuggestion: "建议学生在申请材料中突出相关实习经历和编程项目经验。"
    }
  ]
}
```



### 2.3 留学方案列表页面（B 移动/PC/DIY页同步调整）
#### 添加方案按钮改动：
![image](https://github.com/user-attachments/assets/6c9ce8fb-3b16-45bb-a344-d7322f352311)
1. 按钮名称改为：添加院校；
2. 按钮弹窗中，直接展示院校库tab页，去掉tab的显示（只保留院校库页面即可）
  ![image](https://github.com/user-attachments/assets/c76bd097-1aee-41e9-a06c-0e20750b7eed)

#### 方案加载中的动画
B 移动/PC同步调整
1. 点击生成方案按钮，进入页面时，按UI设计稿进行动画展示；
2. 动画展示完成，动画区域消失，按现有排版样式展示推荐的方案信息；

### 2.4 小希留学顾问页面
涉及页面：
1. B端移动/PC小希助理页，正常做展示渲染；
2. B端八步流程提问：不展示，过滤掉方案类型的历史消息；
3. B的C，代理查看时禁用聊天功能，消息记录也不展示，在上霄的需求中；
4. C端：小程序、澳际官网(B端知识库)正常做展示渲染；
   
#### 功能点 1：方案任务逻辑调整
- **交互逻辑**：任务分发逻辑调整
- **数据来源**：对话内容
- **具体要求**：
  1. 当识别到方案任务时，调用coze智能体接口发起对话；
  2. coze智能体中设置有追问逻辑，若识别到信息不足，则返回追问问题，保持方案任务状态；
  3. coze将对收到的每一句对话结合上下文识别意图，会返回三类意图：1. 方案制作；2. 信息追问；3. 其他意图；
  4. 若识别到其他意图，则智能体当前任务结束，小希使用用户问题重新识别意图并分发（排除掉方案制作意图，避免死循环）；
  5. 若用户意图是方案制作，则根据原型给定的样式进行智能体小希渲染，否则按照文本消息渲染即可；

#### 功能点 2：消息卡片渲染
- **交互逻辑**：智能体会优先返回意图，根据意图类型确定是否使用方案卡片的渲染
- **数据来源**：智能体消息
- **具体要求**：
  1. 根据UI进行三步动画的渲染、展示；
  2. 智能体返回方案数据后，根据UI完成卡片的渲染；
  3. 原有的复制、重新发送、点踩、点赞功能保留不变；

#### 功能点 3：转到资源方案
- **交互逻辑**：方案卡片有转到资源的按钮，点击后跳转到资源方案标签页，触发添加资源弹窗
- **数据来源**：智能体生成的方案数据
- **具体要求**：
  1. 生成方案的同时，智能体会返回解析出的格式化的用户信息
  2. 点击按钮后，跳转到资源方案页面，触发新增资源弹窗
  3. 3. 系统自动将智能体返回的资源信息填入表单，等待用户操作
    
## 补充的注意点：
1. 小希助理对话时：点击同步至资源方案按钮，不创建学生，直接显示弹窗，将AI带的信息填充过去，让用户填写姓名自己创建；
2. 多轮对话如果有多个学生，信息会错乱，风险点，暂时先不考虑，是小希助理整体对话流的问题，后续切换百炼时再解决；
3. 补一个前端展示对应的后端字段图示；
4. 没返回专业ID，用户端交互；
5. 加载中不可以操作提人工和重新推荐；
6. 当前是否前端限制保持一个会话，同时只能进行一个会话；
7. 个人分析字段长度限制，避免过长；


## 测试
> 需注意压测环节，测试Coze回复的稳定性以及并发数

## 二期需求（5月不做）

### 其他需求
#### 功能点 1：方案列表页面功能按钮优化（暂不做，放到二期）
- **交互逻辑**：优化页面头部功能按钮和交互行为
- **数据来源**：-
- **具体要求**：
  1. 保留现有的"下载方案模板"功能按钮，用于导出方案模板
  2. 保留"查看更多方案"功能按钮，用于展示额外的方案选项
  3. 保留"提交人工优化"功能按钮，用于将方案提交给顾问人工优化
  4. 新增"重新推荐方案"功能按钮，整合新的智能体调用逻辑
  5. 新增"功能引导"按钮，优化引导流程和视觉提示

#### 功能点 2：方案卡片展示优化（暂不做，放到二期）
- **交互逻辑**：优化方案卡片内容的展示布局，保持现有功能，新增信息展开/收起按钮
- **数据来源**：智能体方案数据
- **具体要求**：
  1. 优化卡片内容的展示布局
  2. 保持现有功能
  3. 增加信息展开/收起按钮
  4. 根据原型实现信息与排版

#### 功能点 3：方案操作功能新增（暂不做，放到二期）
- **交互逻辑**：布局调整，突出方案锁定与方案同步按钮，原有其他功能收起到更多功能菜单，新增方案锁定功能
- **数据来源**：-
- **具体要求**：
  1. 保留同步到定校功能
  2. 新增方案锁定功能，确保重新推荐时不会刷新锁定的方案、人工推荐不受该影响
  3. 保留更多菜单中的编辑方案、复制方案、查看申请材料、删除方案等功能
  4. 编辑点击后，弹窗，窗体主要内容为表单，详见原型，用户在表单中进行方案编辑与保存；

#### 功能点 4：方案锁定功能（暂不做，放到二期）
- **交互逻辑**：实现方案锁定功能，防止方案刷新
- **数据来源**：-
- **具体要求**：
  1. 在方案卡片右上角添加锁定/解锁按钮，使用锁形图标直观展示状态，详见UI
  2. 锁定状态下，方案不能被编辑、删除或重新推荐，但不影响人工推荐
  3. 锁定状态在数据库存储，确保刷新页面后状态不丢失
  4. 锁定状态不影响人工优化功能，人工可以对锁定的方案修改和删除，若人工优化完，方案专业id未变，则视为同一个专业方案，锁定状态保持不变
  5. 记录锁定功能操作数据，用于新功能上线后的数据跟踪，验证功能使用情况

#### 功能点 5：重新推荐方案（暂不做，放到二期）
- **交互逻辑**：实现方案重新推荐功能，通过智能体生成新的方案
- **数据来源**：智能体推荐数据
- **具体要求**：
  1. 点击"重新推荐方案"按钮后，弹出抽屉，显示需填写的表单信息，内容详见UI
  2. 已锁定的方案不参与重新推荐，保持原有方案不变
  3. 已锁定的方案不占用推荐方案数量，若锁定2所，重新推回5所，则列表变为7所
  4. 点击重新推荐时，方案面板出现三步式加载动画，详见UI设计
  5. 记录按钮点击数据，记录提交按钮与取消按钮点击数据，用于上线后的数据分析

#### 功能点 6：编辑对话框功能优化（暂不做，放到二期）
- **交互逻辑**：将编辑功能收起到更多功能菜单，点击后弹窗进行方案表单编辑，具体字段详见原型；
- **数据来源**：方案数据和用户编辑内容
- **具体要求**：
  1. 保留现有编辑对话框的布局和字段结构
  2. 确保所有可编辑字段正确显示并支持用户修改
  3. 保留只读字段的样式和标识
  4. 现有的必填字段规则以及字段内容校验不变
  5. 当前版本可编辑字段缺失如下字段，需新增：语言要求：IELTS、TOEFL;学术要求：GPA、背景要求；其他信息：院系、校区、申请建议；

#### 功能点 7：方案评价功能（暂不做，放到二期）
- **交互逻辑**：当方案推荐后（首次推荐或主动点击重新推荐按钮），用户首次浏览页面到最底部，则触发评价弹窗，右下角弹窗；
- **数据来源**：-
- **具体要求**：
  1. 记录评级弹出日志数据，与用户的评价结果进行关联（后续根据提交率数据调整评价弹出方式）；
  2. 以5颗星级的方式让用户选择评价星级，若选择4星或以下，则星级下方会出现："院校信息不准"、"推荐院校不准"、"流程复杂"三个标签供用户选择，用户可选可不选，同时支持填写文本反馈，详见UI；
  3. 每个用户30日内最多弹出1次；

#### 功能点 1：提交平台优化（暂不做，放到二期）
- **交互逻辑**：优化提交平台反馈信息的处理逻辑
- **数据来源**：用户提交的反馈信息
- **具体要求**：
  1. 当用户填写其他要求后又提交人工反馈时，将两者信息进行拼接
  2. 管理后台和开放平台均采用分号分隔的方式拼接信息（其他要求 ； 提交人工反馈）
  3. 确保信息拼接后的格式统一且易于阅读

#### 功能点 2：成绩类型默认值优化（暂不做，放到二期）
- **交互逻辑**：根据用户背景学历自动设置成绩类型默认值
- **数据来源**：用户背景学历信息
- **具体要求**：
  1. 当用户背景学历为硕士时，自动将成绩类型设置为"其他成绩类型"

#### 功能点 3：下载模板优化（暂不做，放到二期）
- **交互逻辑**：优化下载模板的展示和下载功能
- **数据来源**：模板数据和用户信息
- **具体要求**：
  1. 按照UI设计调整模板样式，突出展示补充信息
  2. 当字段内容为空时自动隐藏该字段
  3. 预览功能改为直接使用页面展示，不再生成PDF
  4. 下载时直接调用页面打印功能生成PDF文件

#### B端小程序：小希云服务（暂不做，放到二期）
  同步调整小希助理对话页以及方案列表页，详见UI

#### 2.2 提交人工逻辑调整
1. 原有提人工前走AI推荐逻辑保留，改为走智能体推荐，将填写的反馈整合到prompt一同发送给智能体；
2. 成功提交人工后，人工推回的方案先提交到智能体B（另一个智能体，负责对人工方案进行信息补充），智能体B将对人工方案补充建议等信息，保障与智能体A返回的数据格式、要求等一致，系统接受到智能体B的返回数据后再返回前端一同渲染；


 
